{% extends "base1.html" %}
{% block title %}Meeting: {{ meeting.name }}{% endblock %}
{% block content %}
<style>
/* Modern Meeting Detail Styles */
.meeting-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    line-height: 1.6;
    color: #333;
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    min-height: 100vh;
}

.meeting-header {
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    color: white;
    padding: 40px 30px;
    border-radius: 20px;
    margin-bottom: 30px;
    box-shadow: 0 20px 40px rgba(37, 99, 235, 0.2);
    animation: slideInFromTop 0.8s ease-out;
}

.meeting-title {
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0 0 20px 0;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.meeting-info {
    display: flex;
    gap: 30px;
    flex-wrap: wrap;
    margin-top: 20px;
}

.info-item {
    display: flex;
    align-items: center;
    gap: 10px;
    background: rgba(255, 255, 255, 0.1);
    padding: 12px 20px;
    border-radius: 50px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.info-icon {
    width: 20px;
    height: 20px;
    opacity: 0.9;
}

.content-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    margin-bottom: 30px;
}

.content-section {
    background: white;
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(226, 232, 240, 0.8);
    transition: all 0.3s ease;
    animation: fadeInUp 0.8s ease-out;
    animation-fill-mode: both;
}

.content-section:nth-child(1) { animation-delay: 0.2s; }
.content-section:nth-child(2) { animation-delay: 0.4s; }

.content-section:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
}

.section-title {
    font-size: 1.8rem;
    font-weight: 600;
    color: #1e293b;
    margin: 0 0 25px 0;
    display: flex;
    align-items: center;
    gap: 12px;
}

.section-icon {
    width: 24px;
    height: 24px;
    color: #2563eb;
}

.transcript-container {
    max-height: 500px;
    overflow-y: auto;
    padding: 20px;
    background: #f8fafc;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    margin-bottom: 20px;
}

.transcript-container::-webkit-scrollbar {
    width: 8px;
}

.transcript-container::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 4px;
}

.transcript-container::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 4px;
}

.transcript-container::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}

.transcript-segment {
    margin-bottom: 20px;
    padding: 15px;
    background: white;
    border-radius: 12px;
    border-left: 4px solid #2563eb;
    transition: all 0.3s ease;
    animation: slideInFromLeft 0.6s ease-out;
}

.transcript-segment:hover {
    transform: translateX(5px);
    box-shadow: 0 5px 15px rgba(37, 99, 235, 0.1);
}

.speaker-name {
    font-weight: 600;
    color: #2563eb;
    margin: 0 0 8px 0;
    font-size: 0.95rem;
}

.transcript-text {
    margin: 0;
    color: #475569;
    line-height: 1.7;
}

.modern-button {
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 50px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 10px;
    box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
    text-decoration: none;
    position: relative;
    overflow: hidden;
    margin-right: 15px;
}

.modern-button.pdf-button {
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
}

.modern-button.pdf-button:hover {
    box-shadow: 0 8px 25px rgba(220, 38, 38, 0.4);
}

.modern-button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s ease;
}

.modern-button:hover::before {
    left: 100%;
}

.modern-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4);
}

.modern-button:active {
    transform: translateY(0);
    box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
}

.modern-button:disabled {
    background: #9ca3af;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.summary-card {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border: 1px solid #7dd3fc;
    border-radius: 16px;
    padding: 25px;
    margin-top: 20px;
    animation: fadeIn 0.8s ease-out;
}

.summary-text {
    color: #0c4a6e;
    font-size: 1.1rem;
    line-height: 1.8;
    margin: 0;
}

.screenshots-section {
    grid-column: 1 / -1;
    margin-top: 20px;
}

.screenshots-slider {
    position: relative;
    margin-top: 20px;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
}

.slider-container {
    position: relative;
    width: 100%;
    height: 400px;
    overflow: hidden;
}

.slider-track {
    display: flex;
    transition: transform 0.5s ease;
    height: 100%;
}

.slide {
    min-width: 100%;
    position: relative;
    background: #f8fafc;
    display: flex;
    align-items: center;
    justify-content: center;
}

.slide img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    border-radius: 12px;
}

.slide-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
    color: white;
    padding: 20px;
    font-size: 1rem;
    backdrop-filter: blur(10px);
}

.slider-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(255, 255, 255, 0.9);
    border: none;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    z-index: 10;
}

.slider-nav:hover {
    background: white;
    transform: translateY(-50%) scale(1.1);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
}

.slider-nav.prev {
    left: 15px;
}

.slider-nav.next {
    right: 15px;
}

.slider-nav svg {
    width: 20px;
    height: 20px;
    color: #2563eb;
}

.slider-dots {
    display: flex;
    justify-content: center;
    gap: 12px;
    margin-top: 20px;
    padding: 0 20px;
}

.dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #cbd5e1;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}

.dot.active {
    background: #2563eb;
    transform: scale(1.2);
}

.dot:hover {
    background: #64748b;
    transform: scale(1.1);
}

.slider-counter {
    text-align: center;
    margin-top: 15px;
    color: #64748b;
    font-size: 0.9rem;
    font-weight: 500;
}

.empty-state {
    text-align: center;
    padding: 40px;
    color: #64748b;
    font-style: italic;
}

.empty-state-icon {
    font-size: 3rem;
    margin-bottom: 15px;
    opacity: 0.5;
}

.button-group {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    align-items: center;
}

.pdf-progress {
    display: none;
    background: #f0f9ff;
    border: 1px solid #7dd3fc;
    border-radius: 12px;
    padding: 20px;
    margin-top: 15px;
    text-align: center;
}

.pdf-progress.show {
    display: block;
    animation: fadeIn 0.3s ease-out;
}

.progress-bar {
    width: 100%;
    height: 8px;
    background: #e0f2fe;
    border-radius: 4px;
    overflow: hidden;
    margin: 15px 0;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #2563eb, #1d4ed8);
    width: 0%;
    transition: width 0.3s ease;
    border-radius: 4px;
}

.progress-text {
    color: #0c4a6e;
    font-size: 0.9rem;
    font-weight: 500;
}

/* Animations */
@keyframes slideInFromTop {
    from {
        opacity: 0;
        transform: translateY(-30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideInFromLeft {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

@keyframes zoomIn {
    from {
        opacity: 0;
        transform: scale(0.8);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

/* Responsive Design */
@media (max-width: 768px) {
    .content-grid {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .meeting-header {
        padding: 30px 20px;
    }
    
    .meeting-title {
        font-size: 2rem;
    }
    
    .meeting-info {
        flex-direction: column;
        gap: 15px;
    }
    
    .content-section {
        padding: 20px;
    }
    
    .section-title {
        font-size: 1.5rem;
    }
    
    .screenshots-grid {
        grid-template-columns: 1fr;
    }
    
    .meeting-container {
        padding: 15px;
    }
    
    .button-group {
        flex-direction: column;
        align-items: stretch;
    }
    
    .modern-button {
        margin-right: 0;
        margin-bottom: 10px;
    }
}

@media (max-width: 480px) {
    .meeting-title {
        font-size: 1.8rem;
    }
    
    .modern-button {
        padding: 12px 24px;
        font-size: 0.9rem;
    }
    
    .transcript-container {
        max-height: 300px;
    }
}
</style>

<!-- Include jsPDF library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<div class="meeting-container">
    <!-- Meeting Header -->
    <div class="meeting-header">
        <h1 class="meeting-title">{{ meeting.name }}</h1>
        <div class="meeting-info">
            <div class="info-item">
                <svg class="info-icon" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span><strong>Bot:</strong> {{ meeting.bot_name }}</span>
            </div>
            <div class="info-item">
                <svg class="info-icon" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"/>
                </svg>
                <span><strong>Join Time:</strong> {{ meeting.join_time }}</span>
            </div>
        </div>
    </div>

    <!-- Content Grid -->
    <div class="content-grid">
        <!-- Transcript Section -->
        <div class="content-section">
            <h2 class="section-title">
                <svg class="section-icon" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                Transcript
            </h2>
            
            <div class="transcript-container">
                {% for seg in segments %}
                <div class="transcript-segment" data-timestamp="{{ seg.timestamp }}">
                    {% if seg.speaker %}
                    <p class="speaker-name">{{ seg.speaker }}</p>
                    {% endif %}
                    <p class="transcript-text">{{ seg.text }}</p>
                </div>
                {% empty %}
                <div class="empty-state">
                    <div class="empty-state-icon">📝</div>
                    <p>No transcript available yet.</p>
                </div>
                {% endfor %}
            </div>
            
            <div class="button-group">
                <form method="POST" action="{% url 'transcribe_meeting' meeting.id %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="modern-button">
                        📝 Generate Transcript
                    </button>
                </form>
            </div>
        </div>

        <!-- Summarize Section -->
        <div class="content-section">
            <h2 class="section-title">
                <svg class="section-icon" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                </svg>
                AI Summary
            </h2>
            
            {% with meeting.transcripts.all as t_list %}
            {% if t_list %}
                {% with t_list.0 as first_trans %}
                    {% if first_trans.summary %}
                    <div class="summary-card">
                        <p class="summary-text">{{ first_trans.summary }}</p>
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <div class="empty-state-icon">💡</div>
                        <p>Ready to generate summary</p>
                        <button onclick="summarize({{ first_trans.id }})" class="modern-button">
                            💡 Summarize Transcript
                        </button>
                    </div>
                    {% endif %}
                {% endwith %}
            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">⏳</div>
                <p>Generate transcript first to create summary</p>
            </div>
            {% endif %}
            {% endwith %}
        </div>

        <!-- Screenshots Section -->
        <div class="content-section screenshots-section">
            <h2 class="section-title">
                <svg class="section-icon" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                Screenshots & Slides
            </h2>
            
            {% if screenshots %}
            <div class="screenshots-slider">
                <div class="slider-container">
                    <div class="slider-track" id="sliderTrack">
                        {% for shot in screenshots %}
                        <div class="slide" data-timestamp="{{ shot.timestamp }}">
                            <img src="/{{ shot.image_path }}" alt="Screenshot at {{ shot.created }}">
                            <div class="slide-overlay">
                                <strong>Captured:</strong> {{ shot.created|date:"M d, Y H:i" }}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    {% if screenshots|length > 1 %}
                    <button class="slider-nav prev" onclick="changeSlide(-1)">
                        <svg fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"/>
                        </svg>
                    </button>
                    <button class="slider-nav next" onclick="changeSlide(1)">
                        <svg fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/>
                        </svg>
                    </button>
                    {% endif %}
                </div>
                
                {% if screenshots|length > 1 %}
                <div class="slider-dots">
                    {% for shot in screenshots %}
                    <button class="dot{% if forloop.first %} active{% endif %}" onclick="goToSlide({{ forloop.counter0 }})"></button>
                    {% endfor %}
                </div>
                <div class="slider-counter">
                    <span id="currentSlide">1</span> / <span id="totalSlides">{{ screenshots|length }}</span>
                </div>
                {% endif %}
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">📸</div>
                <p>No screenshots captured yet.</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- PDF Export Section - Only show when summary exists and at the bottom -->
    {% with meeting.transcripts.all as t_list %}
    {% if t_list %}
        {% with t_list.0 as first_trans %}
            {% if first_trans.summary %}
            <div class="content-section" style="margin-top: 30px;">
                <h2 class="section-title">
                    <svg class="section-icon" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 10.586l4.707-4.707 1.414 1.414L13.414 12l4.707 4.707-1.414 1.414L12 13.414l-4.707 4.707-1.414-1.414L10.586 12 5.879 7.293l1.414-1.414L12 10.586zM3 18h18v2H3v-2z"/>
                    </svg>
                    Export Meeting Report
                </h2>
                
                <p style="color: #64748b; margin-bottom: 25px; line-height: 1.6;">
                    Generate a comprehensive PDF report including the meeting transcript with timestamps, 
                    relevant screenshots, and AI summary. Perfect for sharing or archival purposes.
                </p>
                
                <div class="button-group">
                    <button onclick="generatePDF()" class="modern-button pdf-button" id="pdfButton">
                        📄 Save as PDF
                    </button>
                </div>
                
                <!-- Progress indicator -->
                <div id="pdfProgress" class="pdf-progress">
                    <div class="progress-text" id="progressText">Preparing PDF...</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>
            </div>
            {% endif %}
        {% endwith %}
    {% endif %}
    {% endwith %}
</div>

<script>
// Slider functionality
let currentSlideIndex = 0;
const slides = document.querySelectorAll('.slide');
const totalSlides = slides.length;

function updateSliderPosition() {
    const track = document.getElementById('sliderTrack');
    if (track) {
        track.style.transform = `translateX(-${currentSlideIndex * 100}%)`;
    }
}

function updateDots() {
    const dots = document.querySelectorAll('.dot');
    dots.forEach((dot, index) => {
        dot.classList.toggle('active', index === currentSlideIndex);
    });
}

function updateCounter() {
    const currentSlideElement = document.getElementById('currentSlide');
    if (currentSlideElement) {
        currentSlideElement.textContent = currentSlideIndex + 1;
    }
}

function changeSlide(direction) {
    if (totalSlides <= 1) return;
    
    currentSlideIndex += direction;
    
    if (currentSlideIndex >= totalSlides) {
        currentSlideIndex = 0;
    } else if (currentSlideIndex < 0) {
        currentSlideIndex = totalSlides - 1;
    }
    
    updateSliderPosition();
    updateDots();
    updateCounter();
}

function goToSlide(index) {
    if (index >= 0 && index < totalSlides) {
        currentSlideIndex = index;
        updateSliderPosition();
        updateDots();
        updateCounter();
    }
}

// Auto-slide functionality (optional)
let autoSlideInterval;

function startAutoSlide() {
    if (totalSlides > 1) {
        autoSlideInterval = setInterval(() => {
            changeSlide(1);
        }, 5000); // Change slide every 5 seconds
    }
}

function stopAutoSlide() {
    if (autoSlideInterval) {
        clearInterval(autoSlideInterval);
    }
}

// Keyboard navigation
document.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowLeft') {
        changeSlide(-1);
    } else if (e.key === 'ArrowRight') {
        changeSlide(1);
    }
});

// Touch/swipe support for mobile
let touchStartX = 0;
let touchEndX = 0;

document.addEventListener('touchstart', function(e) {
    touchStartX = e.changedTouches[0].screenX;
});

document.addEventListener('touchend', function(e) {
    touchEndX = e.changedTouches[0].screenX;
    handleSwipe();
});

function handleSwipe() {
    const swipeThreshold = 50;
    const diff = touchStartX - touchEndX;
    
    if (Math.abs(diff) > swipeThreshold) {
        if (diff > 0) {
            changeSlide(1); // Swipe left, go to next slide
        } else {
            changeSlide(-1); // Swipe right, go to previous slide
        }
    }
}

function summarize(id) {
    // Add loading state
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '⏳ Generating Summary...';
    button.disabled = true;
    
    fetch("{% url 'summarize_transcript' 0 %}".replace('/0/', `/${id}/`), {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Accept": "application/json"
        }
    })
    .then(res => {
        if (!res.ok) {
            return res.text().then(text => { throw new Error(text); });
        }
        return res.json();
    })
    .then(data => {
        if (data.success) {
            // Add smooth reload with animation
            document.body.style.opacity = '0';
            setTimeout(() => {
                location.reload();
            }, 300);
        } else {
            alert("Summarization failed: " + data.error);
            button.innerHTML = originalText;
            button.disabled = false;
        }
    })
    .catch(err => {
        console.error("Error:", err);
        alert("Network error: " + err.message);
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

// PDF Generation Function
async function generatePDF() {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    
    // Show progress
    const progressDiv = document.getElementById('pdfProgress');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const pdfButton = document.getElementById('pdfButton');
    
    progressDiv.classList.add('show');
    pdfButton.disabled = true;
    
    try {
        // PDF Configuration
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        const margin = 20;
        const contentWidth = pageWidth - (margin * 2);
        let yPosition = margin;
        
        // Helper function to add new page if needed
        function checkNewPage(requiredHeight = 20) {
            if (yPosition + requiredHeight > pageHeight - margin) {
                pdf.addPage();
                yPosition = margin;
                return true;
            }
            return false;
        }
        
        // Helper function to wrap text
        function wrapText(text, maxWidth, fontSize = 10) {
            pdf.setFontSize(fontSize);
            const words = text.split(' ');
            const lines = [];
            let currentLine = '';
            
            for (const word of words) {
                const testLine = currentLine + (currentLine ? ' ' : '') + word;
                const textWidth = pdf.getStringUnitWidth(testLine) * fontSize / pdf.internal.scaleFactor;
                
                if (textWidth > maxWidth && currentLine) {
                    lines.push(currentLine);
                    currentLine = word;
                } else {
                    currentLine = testLine;
                }
            }
            
            if (currentLine) {
                lines.push(currentLine);
            }
            
            return lines;
        }
        
        // Update progress
        progressText.textContent = 'Creating PDF header...';
        progressFill.style.width = '10%';
        
        // Title Page
        pdf.setFontSize(24);
        pdf.setFont('helvetica', 'bold');
        pdf.text('Meeting Report', pageWidth / 2, yPosition + 20, { align: 'center' });
        
        yPosition += 35;
        pdf.setFontSize(18);
        pdf.text('{{ meeting.name }}', pageWidth / 2, yPosition, { align: 'center' });
        
        yPosition += 20;
        pdf.setFontSize(12);
        pdf.setFont('helvetica', 'normal');
        pdf.text('Bot: {{ meeting.bot_name }}', pageWidth / 2, yPosition, { align: 'center' });
        yPosition += 8;
        pdf.text('Join Time: {{ meeting.join_time }}', pageWidth / 2, yPosition, { align: 'center' });
        yPosition += 8;
        pdf.text('Generated: ' + new Date().toLocaleString(), pageWidth / 2, yPosition, { align: 'center' });
        
        // Add a line separator
        yPosition += 20;
        pdf.setDrawColor(66, 139, 202);
        pdf.setLineWidth(0.5);
        pdf.line(margin, yPosition, pageWidth - margin, yPosition);
        yPosition += 20;
        
        // Update progress
        progressText.textContent = 'Processing transcript segments...';
        progressFill.style.width = '20%';
        
        // Get transcript segments and screenshots data
        const transcriptSegments = [];
        const screenshots = [];
        
        // Collect transcript data
        document.querySelectorAll('.transcript-segment').forEach(segment => {
            const speaker = segment.querySelector('.speaker-name')?.textContent || 'Unknown';
            const text = segment.querySelector('.transcript-text')?.textContent || '';
            const timestamp = segment.getAttribute('data-timestamp') || '';
            
            transcriptSegments.push({
                speaker: speaker,
                text: text,
                timestamp: timestamp
            });
        });
        
        // Collect screenshot data
        document.querySelectorAll('.slide').forEach((slide, index) => {
            const img = slide.querySelector('img');
            const timestamp = slide.getAttribute('data-timestamp') || '';
            const overlay = slide.querySelector('.slide-overlay')?.textContent || '';
            
            if (img) {
                screenshots.push({
                    src: img.src,
                    timestamp: timestamp,
                    caption: overlay,
                    index: index
                });
            }
        });
        
        // Function to find closest screenshot for a transcript segment
        function findClosestScreenshot(transcriptTimestamp) {
            if (!transcriptTimestamp || screenshots.length === 0) return null;
            
            let closest = null;
            let minDiff = Infinity;
            
            screenshots.forEach(screenshot => {
                if (screenshot.timestamp) {
                    const diff = Math.abs(new Date(transcriptTimestamp) - new Date(screenshot.timestamp));
                    if (diff < minDiff) {
                        minDiff = diff;
                        closest = screenshot;
                    }
                }
            });
            
            return closest;
        }
        
        // Add Transcript with Screenshots Section
        checkNewPage(30);
        pdf.setFontSize(16);
        pdf.setFont('helvetica', 'bold');
        pdf.text('Meeting Transcript', margin, yPosition);
        yPosition += 15;
        
        progressText.textContent = 'Adding transcript segments...';
        
        for (let i = 0; i < transcriptSegments.length; i++) {
            const segment = transcriptSegments[i];
            const progress = 20 + (i / transcriptSegments.length) * 40;
            progressFill.style.width = progress + '%';
            
            checkNewPage(40);
            
            // Add speaker name
            pdf.setFontSize(11);
            pdf.setFont('helvetica', 'bold');
            pdf.setTextColor(37, 99, 235); // Blue color
            pdf.text(segment.speaker, margin, yPosition);
            yPosition += 8;
            
            // Add timestamp if available
            if (segment.timestamp) {
                pdf.setFontSize(9);
                pdf.setFont('helvetica', 'italic');
                pdf.setTextColor(100, 116, 139); // Gray color
                pdf.text('Time: ' + new Date(segment.timestamp).toLocaleTimeString(), margin, yPosition);
                yPosition += 6;
            }
            
            // Add transcript text
            pdf.setFontSize(10);
            pdf.setFont('helvetica', 'normal');
            pdf.setTextColor(0, 0, 0); // Black color
            
            const textLines = wrapText(segment.text, contentWidth - 10, 10);
            textLines.forEach(line => {
                checkNewPage(8);
                pdf.text(line, margin + 5, yPosition);
                yPosition += 6;
            });
            
            // Try to add relevant screenshot
            const closestScreenshot = findClosestScreenshot(segment.timestamp);
            if (closestScreenshot && i % 3 === 0) { // Add screenshot every 3rd segment to avoid cluttering
                try {
                    checkNewPage(80);
                    
                    // Create a canvas to load and resize the image
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    
                    // Wait for image to load
                    await new Promise((resolve, reject) => {
                        img.onload = resolve;
                        img.onerror = reject;
                        img.crossOrigin = 'anonymous';
                        img.src = closestScreenshot.src;
                    });
                    
                    // Calculate dimensions
                    const maxWidth = contentWidth - 20;
                    const maxHeight = 60;
                    let imgWidth = img.width;
                    let imgHeight = img.height;
                    
                    // Scale down if necessary
                    if (imgWidth > maxWidth) {
                        imgHeight = (imgHeight * maxWidth) / imgWidth;
                        imgWidth = maxWidth;
                    }
                    if (imgHeight > maxHeight) {
                        imgWidth = (imgWidth * maxHeight) / imgHeight;
                        imgHeight = maxHeight;
                    }
                    
                    // Set canvas size and draw image
                    canvas.width = imgWidth;
                    canvas.height = imgHeight;
                    ctx.drawImage(img, 0, 0, imgWidth, imgHeight);
                    
                    // Add to PDF
                    const imgData = canvas.toDataURL('image/jpeg', 0.7);
                    pdf.addImage(imgData, 'JPEG', margin + 10, yPosition, imgWidth * 0.75, imgHeight * 0.75);
                    yPosition += (imgHeight * 0.75) + 5;
                    
                    // Add caption
                    pdf.setFontSize(8);
                    pdf.setFont('helvetica', 'italic');
                    pdf.setTextColor(100, 116, 139);
                    const captionLines = wrapText('Screenshot: ' + closestScreenshot.caption, maxWidth, 8);
                    captionLines.forEach(line => {
                        pdf.text(line, margin + 10, yPosition);
                        yPosition += 5;
                    });
                    
                } catch (error) {
                    console.log('Could not add screenshot:', error);
                }
            }
            
            yPosition += 10; // Space between segments
        }
        
        // Update progress
        progressText.textContent = 'Adding meeting summary...';
        progressFill.style.width = '80%';
        
        // Add Summary Section
        checkNewPage(50);
        yPosition += 10;
        pdf.setFontSize(16);
        pdf.setFont('helvetica', 'bold');
        pdf.setTextColor(0, 0, 0);
        pdf.text('Meeting Summary', margin, yPosition);
        yPosition += 15;
        
        // Add summary content
        const summaryText = document.querySelector('.summary-text')?.textContent || 'No summary available';
        pdf.setFontSize(11);
        pdf.setFont('helvetica', 'normal');
        
        const summaryLines = wrapText(summaryText, contentWidth, 11);
        summaryLines.forEach(line => {
            checkNewPage(8);
            pdf.text(line, margin, yPosition);
            yPosition += 7;
        });
        
        // Update progress
        progressText.textContent = 'Adding remaining screenshots...';
        progressFill.style.width = '90%';
        
        // Add Screenshots Appendix (if any screenshots weren't included above)
        if (screenshots.length > 0) {
            checkNewPage(50);
            yPosition += 20;
            pdf.setFontSize(16);
            pdf.setFont('helvetica', 'bold');
            pdf.text('Screenshots Appendix', margin, yPosition);
            yPosition += 15;
            
            for (let i = 0; i < Math.min(screenshots.length, 5); i++) { // Limit to 5 screenshots
                const screenshot = screenshots[i];
                
                try {
                    checkNewPage(100);
                    
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    
                    await new Promise((resolve, reject) => {
                        img.onload = resolve;
                        img.onerror = reject;
                        img.crossOrigin = 'anonymous';
                        img.src = screenshot.src;
                    });
                    
                    // Calculate dimensions for appendix (larger images)
                    const maxWidth = contentWidth;
                    const maxHeight = 100;
                    let imgWidth = img.width;
                    let imgHeight = img.height;
                    
                    if (imgWidth > maxWidth) {
                        imgHeight = (imgHeight * maxWidth) / imgWidth;
                        imgWidth = maxWidth;
                    }
                    if (imgHeight > maxHeight) {
                        imgWidth = (imgWidth * maxHeight) / imgHeight;
                        imgHeight = maxHeight;
                    }
                    
                    canvas.width = imgWidth;
                    canvas.height = imgHeight;
                    ctx.drawImage(img, 0, 0, imgWidth, imgHeight);
                    
                    const imgData = canvas.toDataURL('image/jpeg', 0.8);
                    pdf.addImage(imgData, 'JPEG', margin, yPosition, imgWidth * 0.75, imgHeight * 0.75);
                    yPosition += (imgHeight * 0.75) + 5;
                    
                    // Add caption
                    pdf.setFontSize(9);
                    pdf.setFont('helvetica', 'italic');
                    pdf.setTextColor(100, 116, 139);
                    const captionLines = wrapText(screenshot.caption, contentWidth, 9);
                    captionLines.forEach(line => {
                        pdf.text(line, margin, yPosition);
                        yPosition += 6;
                    });
                    
                    yPosition += 15;
                    
                } catch (error) {
                    console.log('Could not add screenshot to appendix:', error);
                }
            }
        }
        
        // Add footer to all pages
        const totalPages = pdf.internal.getNumberOfPages();
        for (let i = 1; i <= totalPages; i++) {
            pdf.setPage(i);
            pdf.setFontSize(8);
            pdf.setFont('helvetica', 'normal');
            pdf.setTextColor(100, 116, 139);
            pdf.text('Meeting Report - {{ meeting.name }}', margin, pageHeight - 10);
            pdf.text(`Page ${i} of ${totalPages}`, pageWidth - margin, pageHeight - 10, { align: 'right' });
        }
        
        // Update progress
        progressText.textContent = 'Finalizing PDF...';
        progressFill.style.width = '100%';
        
        // Save the PDF
        const filename = '{{ meeting.name }}'.replace(/[^a-z0-9]/gi, '_').toLowerCase() + '_meeting_report.pdf';
        pdf.save(filename);
        
        // Hide progress and re-enable button
        setTimeout(() => {
            progressDiv.classList.remove('show');
            pdfButton.disabled = false;
            progressFill.style.width = '0%';
        }, 1000);
        
    } catch (error) {
        console.error('PDF generation error:', error);
        alert('Error generating PDF: ' + error.message);
        
        // Hide progress and re-enable button
        progressDiv.classList.remove('show');
        pdfButton.disabled = false;
        progressFill.style.width = '0%';
    }
}

// Add smooth page transitions
document.addEventListener('DOMContentLoaded', function() {
    document.body.style.opacity = '1';
    
    // Initialize slider
    if (totalSlides > 0) {
        updateSliderPosition();
        updateDots();
        updateCounter();
        
        // Start auto-slide
        startAutoSlide();
        
        // Pause auto-slide on hover
        const sliderContainer = document.querySelector('.slider-container');
        if (sliderContainer) {
            sliderContainer.addEventListener('mouseenter', stopAutoSlide);
            sliderContainer.addEventListener('mouseleave', startAutoSlide);
        }
    }
});
</script>
{% endblock %}